<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Catatan Ngaji Pro - Stable Version</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Inter:wght@300;400;600;700&display=swap');
        body { background-color: #f8fafc; font-family: 'Inter', sans-serif; }
        .font-arabic { font-family: 'Amiri', serif; line-height: 2.2; direction: rtl; }
        .animate-fade { animation: fadeIn 0.5s ease-out; }
        @keyframes fadeIn { from { opacity:0; transform: translateY(10px); } to { opacity:1; transform: translateY(0); } }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        .modal-overlay { background-color: rgba(0,0,0,0.5); }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, deleteDoc, updateDoc, doc, query, onSnapshot, serverTimestamp, setDoc, getDoc, orderBy, limit } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        // --- KODE FIREBASE ANDA ---
        const firebaseConfig = {
            apiKey: "AIzaSyD0XGoRIIntaMiD-xuJUJsA38-jwiz3zxs",
            authDomain: "catatan-ngaji-app.firebaseapp.com",
            projectId: "catatan-ngaji-app",
            storageBucket: "catatan-ngaji-app.firebasestorage.app",
            messagingSenderId: "642649959513",
            appId: "1:642649959513:web:497a3120235e5ce0f61548"
        };

        const app = initializeApp(firebaseConfig);
        window.db = getFirestore(app);
        window.auth = getAuth(app);
        window.fb = { collection, addDoc, deleteDoc, updateDoc, doc, query, onSnapshot, serverTimestamp, setDoc, getDoc, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged, orderBy, limit };
    </script>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;

        /* ================= DATA DATABASE ================= */
        const SURAH_LIST = ["1. Al-Fatihah", "2. Al-Baqarah", "3. Ali 'Imran", "4. An-Nisa", "5. Al-Maidah", "6. Al-An'am", "7. Al-A'raf", "8. Al-Anfal", "9. At-Taubah", "10. Yunus", "11. Hud", "12. Yusuf", "13. Ar-Ra'd", "14. Ibrahim", "15. Al-Hijr", "16. An-Nahl", "17. Al-Isra", "18. Al-Kahf", "19. Maryam", "20. Taha", "21. Al-Anbiya", "22. Al-Hajj", "23. Al-Mu'minun", "24. An-Nur", "25. Al-Furqan", "26. Asy-Syu'ara", "27. An-Naml", "28. Al-Qasas", "29. Al-Ankabut", "30. Ar-Rum", "31. Luqman", "32. As-Sajdah", "33. Al-Ahzab", "34. Saba'", "35. Fatir", "36. Yasin", "37. As-Saffat", "38. Sad", "39. Az-Zumar", "40. Al-Mu'min", "41. Fussilat", "42. Asy-Syura", "43. Az-Zukhruf", "44. Ad-Dukhan", "45. Al-Jasiyah", "46. Al-Ahqaf", "47. Muhammad", "48. Al-Fath", "49. Al-Hujurat", "50. Qaf", "51. Az-Zariyat", "52. At-Tur", "53. An-Najm", "54. Al-Qamar", "55. Ar-Rahman", "56. Al-Waqi'ah", "57. Al-Hadid", "58. Al-Mujadilah", "59. Al-Hasyr", "60. Al-Mumtahanah", "61. As-Saff", "62. Al-Jumu'ah", "63. Al-Munafiqun", "64. At-Tagabun", "65. At-Talaq", "66. At-Tahrim", "67. Al-Mulk", "68. Al-Qalam", "69. Al-Haqqah", "70. Al-Ma'arij", "71. Nuh", "72. Al-Jinn", "73. Al-Muzzammil", "74. Al-Muddassir", "75. Al-Qiyamah", "76. Al-Insan", "77. Al-Mursalat", "78. An-Naba", "79. An-Nazi'at", "80. 'Abasa", "81. At-Takwir", "82. Al-Infitar", "83. Al-Mutaffifin", "84. Al-Insyiqaq", "85. Al-Buruj", "86. At-Tariq", "87. Al-A'la", "88. Al-Ghasyiyah", "89. Al-Fajr", "90. Al-Balad", "91. Asy-Syams", "92. Al-Lail", "93. Ad-Duha", "94. Asy-Syarh", "95. At-Tin", "96. Al-'Alaq", "97. Al-Qadr", "98. Al-Bayyinah", "99. Az-Zalzalah", "100. Al-'Adiyat", "101. Al-Qari'ah", "102. At-Takasur", "103. Al-'Asr", "104. Al-Humazah", "105. Al-Fil", "106. Quraisy", "107. Al-Ma'un", "108. Al-Kausar", "109. Al-Kafirun", "110. An-Nasr", "111. Al-Lahab", "112. Al-Ikhlas", "113. Al-Falaq", "114. An-Nas"];
        const IQRO_LEVELS = ["Iqro 1", "Iqro 2", "Iqro 3", "Iqro 4", "Iqro 5", "Iqro 6"];
        const DOA_DATA = [
            { title: "Mohon Ilmu Bermanfaat", arabic: "ÿßŸéŸÑŸÑŸéŸëŸáŸèŸÖŸéŸë ÿ•ŸêŸÜŸêŸëŸäŸí ÿ£Ÿéÿ≥Ÿíÿ£ŸéŸÑŸèŸÉŸé ÿπŸêŸÑŸíŸÖŸãÿß ŸÜŸéÿßŸÅŸêÿπŸãÿß...", meaning: "Ya Allah! Sesungguhnya aku mohon kepadaMu ilmu yang bermanfaat..." },
            { title: "Untuk Kedua Orangtua", arabic: "ÿßŸéŸÑŸÑŸéŸëŸáŸèŸÖŸéŸë ÿßÿ∫ŸíŸÅŸêÿ±ŸíŸÑŸêŸäŸí ŸàŸéŸÑŸêŸàŸéÿßŸÑŸêÿØŸéŸäŸéŸë ŸàŸéÿßÿ±Ÿíÿ≠ŸéŸÖŸíŸáŸèŸÖŸéÿß...", meaning: "Ya Allah ampunilah dosaku dan dosa kedua orang tuaku..." },
            { title: "Sebelum Makan", arabic: "ÿ®Ÿêÿ≥ŸíŸÖŸê ÿßŸÑŸÑŸáŸê", meaning: "Dengan menyebut nama Allah." },
            { title: "Sesudah Makan", arabic: "ÿßŸÑŸíÿ≠ŸéŸÖŸíÿØŸè ŸÑŸêŸÑŸéŸëŸáŸê ÿßŸÑŸéŸëÿ∞ŸêŸäŸí ÿ£Ÿéÿ∑ŸíÿπŸéŸÖŸéŸÜŸêŸäŸí ŸáŸéÿ∞Ÿéÿß...", meaning: "Segala puji bagi Allah yang memberi makan ini kepadaku..." },
            { title: "Masuk Kamar Mandi", arabic: "ÿßŸéŸÑŸÑŸéŸëŸáŸèŸÖŸéŸë ÿ•ŸêŸÜŸêŸëŸäŸí ÿ£ŸéÿπŸèŸàŸíÿ∞Ÿè ÿ®ŸêŸÉŸé ŸÖŸêŸÜŸé ÿßŸÑŸíÿÆŸèÿ®Ÿèÿ´Ÿê...", meaning: "Ya Allah, sesungguhnya aku berlindung kepadaMu..." },
            { title: "Keluar Kamar Mandi", arabic: "ÿ∫ŸèŸÅŸíÿ±ŸéÿßŸÜŸéŸÉŸé", meaning: "Aku mohon ampun kepadaMu ya Allah." },
            { title: "Sebelum Tidur", arabic: "ÿ®Ÿêÿßÿ≥ŸíŸÖŸêŸÉŸé ÿßŸÑŸÑŸéŸëŸáŸèŸÖŸéŸë ÿ£ŸéŸÖŸèŸàŸíÿ™Ÿè ŸàŸéÿ£Ÿéÿ≠ŸíŸäŸéÿß", meaning: "Dengan menyebut namaMu, ya Allah! Aku mati dan aku hidup." },
            { title: "Bangun Tidur", arabic: "ÿßŸéŸÑŸíÿ≠ŸéŸÖŸíÿØŸè ŸÑŸêŸÑŸéŸëŸáŸê ÿßŸÑŸéŸëÿ∞ŸêŸäŸí ÿ£Ÿéÿ≠ŸíŸäŸéÿßŸÜŸéÿß ÿ®ŸéÿπŸíÿØŸé ŸÖŸéÿß ÿ£ŸéŸÖŸéÿßÿ™ŸéŸÜŸéÿß...", meaning: "Segala puji bagi Allah, yang menghidupkan kami..." },
            { title: "Masuk Masjid", arabic: "ÿßŸéŸÑŸÑŸéŸëŸáŸèŸÖŸéŸë ÿßŸÅŸíÿ™Ÿéÿ≠Ÿí ŸÑŸêŸäŸí ÿ£Ÿéÿ®ŸíŸàŸéÿßÿ®Ÿé ÿ±Ÿéÿ≠ŸíŸÖŸéÿ™ŸêŸÉŸé", meaning: "Ya Allah, bukalah untukku pintu-pintu rahmat-Mu." },
            { title: "Keluar Masjid", arabic: "ÿßŸéŸÑŸÑŸéŸëŸáŸèŸÖŸéŸë ÿ•ŸêŸÜŸêŸëŸäŸí ÿ£Ÿéÿ≥Ÿíÿ£ŸéŸÑŸèŸÉŸé ŸÖŸêŸÜŸí ŸÅŸéÿ∂ŸíŸÑŸêŸÉŸé", meaning: "Ya Allah, sesungguhnya aku memohon karunia-Mu." },
            { title: "Kebaikan Dunia Akhirat", arabic: "ÿ±Ÿéÿ®ŸéŸëŸÜŸéÿß ÿ¢ÿ™ŸêŸÜŸéÿß ŸÅŸêŸä ÿßŸÑÿØŸèŸëŸÜŸíŸäŸéÿß ÿ≠Ÿéÿ≥ŸéŸÜŸéÿ©Ÿã...", meaning: "Wahai Tuhan kami, berilah kami kebaikan di dunia dan akhirat." }
        ];
        const HADITS_DATA = [
            { title: "Tentang Niat", arabic: "ÿ•ŸêŸÜŸéŸëŸÖŸéÿß ÿßŸíŸÑÿ£ŸéÿπŸíŸÖŸéÿßŸÑŸè ÿ®ŸêÿßŸÑŸÜŸêŸëŸäŸéŸëÿßÿ™Ÿê", meaning: "Sesungguhnya amal itu tergantung dari niatnya." },
            { title: "Kebersihan", arabic: "ÿßŸÑÿ∏ŸèŸëŸáŸèŸàŸíÿ±Ÿè ÿ¥Ÿéÿ∑Ÿíÿ±Ÿè ÿßŸíŸÑÿ•ŸêŸäŸíŸÖŸéÿßŸÜŸê", meaning: "Kebersihan itu sebagian dari iman." },
            { title: "Senyum Sedekah", arabic: "ÿ™Ÿéÿ®Ÿéÿ≥ŸèŸëŸÖŸèŸÉŸé ŸÅŸêŸäŸí ŸàŸéÿ¨ŸíŸáŸê ÿ£ŸéÿÆŸêŸäŸíŸÉŸé ŸÑŸéŸÉŸé ÿµŸéÿØŸéŸÇŸéÿ©Ÿå", meaning: "Senyummu di hadapan saudaramu adalah sedekah." },
            { title: "Marah", arabic: "ŸÑÿßŸé ÿ™Ÿéÿ∫Ÿíÿ∂Ÿéÿ®Ÿí ŸàŸéŸÑŸéŸÉŸé ÿßŸÑŸíÿ¨ŸéŸÜŸéŸëÿ©Ÿè", meaning: "Janganlah engkau marah, niscaya bagimu surga." },
            { title: "Menuntut Ilmu", arabic: "ÿ∑ŸéŸÑŸéÿ®Ÿè ÿßŸÑŸíÿπŸêŸÑŸíŸÖŸê ŸÅŸéÿ±ŸêŸäŸíÿ∂Ÿéÿ©Ÿå ÿπŸéŸÑŸéŸâ ŸÉŸèŸÑŸêŸë ŸÖŸèÿ≥ŸíŸÑŸêŸÖŸç", meaning: "Menuntut ilmu itu wajib atas setiap muslim." },
            { title: "Tangan Diatas", arabic: "ÿßŸéŸÑŸíŸäŸéÿØŸè ÿßŸÑŸíÿπŸèŸÑŸíŸäŸéÿß ÿÆŸéŸäŸíÿ±Ÿå ŸÖŸêŸÜŸé ÿßŸÑŸíŸäŸéÿØŸê ÿßŸÑÿ≥ŸèŸëŸÅŸíŸÑŸéŸâ", meaning: "Tangan di atas lebih baik dari pada tangan di bawah." },
            { title: "Surga Ibu", arabic: "ÿßŸÑŸíÿ¨ŸéŸÜŸéŸëÿ©Ÿè ÿ™Ÿéÿ≠Ÿíÿ™Ÿé ÿ£ŸéŸÇŸíÿØŸéÿßŸÖŸê ÿßŸÑŸíÿ£ŸèŸÖŸéŸëŸáŸéÿßÿ™Ÿê", meaning: "Surga itu di bawah telapak kaki ibu." },
            { title: "Sebaik-baik Manusia", arabic: "ÿÆŸéŸäŸíÿ±Ÿè ÿßŸÑŸÜŸéŸëÿßÿ≥Ÿê ÿ£ŸéŸÜŸíŸÅŸéÿπŸèŸáŸèŸÖŸí ŸÑŸêŸÑŸÜŸéŸëÿßÿ≥Ÿê", meaning: "Sebaik-baik manusia adalah yang paling bermanfaat bagi manusia." }
        ];
        const ADAB_LIST = ["Adab Makan & Minum", "Adab Kepada Orang Tua", "Adab Kepada Guru", "Adab Di Masjid", "Adab Berpakaian", "Adab Tidur", "Adab Membaca Al-Quran", "Adab Berteman", "Adab Di Jalan", "Adab Berbicara"];

        // --- HELPER COMPONENTS ---
        const Icon = ({name, size=18, className=''}) => {
            const i = {
                book: "üìñ", users: "üë•", chart: "üìä", plus: "‚ûï", trash: "üóëÔ∏è", save: "üíæ", 
                check: "‚úÖ", alert: "‚ö†Ô∏è", refresh: "üîÑ", login: "üîë", logout: "üö™", 
                sun: "‚òÄÔ∏è", moon: "üåô", star: "‚≠ê", heart: "‚ù§Ô∏è", search: "üîç", filter: "üå™Ô∏è",
                calendar: "üìÖ", download: "üì•", upload: "üì§", edit: "‚úèÔ∏è", minus: "‚õî", file: "üìù"
            };
            return <span className={`mr-1 inline-block ${className}`} style={{fontSize: size}}>{i[name]||"‚Ä¢"}</span>;
        }

        const generatePDF = (data, info, filterName, startDate, endDate, evaluations) => {
            if(!window.jspdf) return alert("Sistem PDF sedang memuat...");
            const doc = new window.jspdf.jsPDF('landscape');
            if(info.logo) { try { doc.addImage(info.logo, 'JPEG', 14, 15, 25, 25); } catch(e) {} }
            const startX = info.logo ? 45 : 14;
            
            doc.setFontSize(18); doc.text("LAPORAN PERKEMBANGAN NGAJI", startX, 22);
            doc.setFontSize(10); doc.text(`Guru: ${info.teacher || '-'} | Tempat: ${info.tpa || '-'}`, startX, 28);
            doc.text(`Santri: ${filterName === 'all' ? 'SEMUA SANTRI' : filterName}`, startX, 33);
            doc.text(`Periode: ${new Date(startDate).toLocaleDateString('id-ID')} s/d ${new Date(endDate).toLocaleDateString('id-ID')}`, startX, 38);
            
            let finalY = 55;
            const rows = data.map(r => {
                const hafalanText = (r.hafalans || []).map(h => `‚≠ê ${h.surah}:${h.ayat} (${h.fluency.split('-')[0]})`).join('\n') || (r.hafalanSurah ? `‚≠ê ${r.hafalanSurah}:${r.hafalanAyat} (${r.hafalanFluency.split('-')[0]})` : '-');
                const extras = [];
                if(r.doa && r.doaFluency) extras.push(`${r.doa} (${r.doaFluency.split('-')[0]})`);
                if(r.hadits && r.haditsFluency) extras.push(`${r.hadits} (${r.haditsFluency.split('-')[0]})`);
                if(r.adab && r.adabFluency) extras.push(`${r.adab} (${r.adabFluency.split('-')[0]})`);

                return [
                    new Date(r.date).toLocaleDateString('id-ID', {day:'2-digit', month:'2-digit'}),
                    r.studentName,
                    r.readingType==='iqro' ? `${r.iqroLevel} Hal ${r.iqroPage}` : `${r.quranSurah}:${r.quranAyat}`,
                    r.readingType==='iqro' ? r.iqroFluency.split(' - ')[0] : r.quranFluency.split(' - ')[0],
                    hafalanText,
                    extras.join('\n') || '-',
                    r.notes || '-'
                ];
            });
            
            doc.autoTable({ head: [["Tgl", "Nama", "Materi", "Nilai", "Hafalan", "Tambahan", "Catatan"]], body: rows, startY: 50, theme: 'grid', styles: { fontSize: 8 }, headStyles: { fillColor: [30, 41, 59] }, didDrawPage: (d) => finalY = d.cursor.y });

            if(filterName !== 'all' && evaluations && evaluations.length > 0) {
                const filteredEvals = evaluations.filter(ev => {
                    const d = new Date(ev.created_at?.seconds * 1000 || Date.now()).toISOString().split('T')[0];
                    return d >= startDate && d <= endDate;
                });
                if(filteredEvals.length > 0) {
                    doc.addPage(); doc.setFontSize(14); doc.text(`RAPOR & EVALUASI: ${filterName}`, 14, 20);
                    let yPos = 30;
                    filteredEvals.forEach((ev) => {
                        if(yPos > 180) { doc.addPage(); yPos = 20; }
                        doc.setFillColor(240, 240, 240); doc.rect(14, yPos-6, 270, 8, 'F');
                        doc.setFontSize(10); doc.setFont("helvetica", "bold");
                        doc.text(`PERIODE: ${ev.period}`, 16, yPos);
                        yPos += 6; doc.setFontSize(10); doc.setFont("helvetica", "normal");
                        const lines = doc.splitTextToSize(ev.content, 265); doc.text(lines, 16, yPos);
                        yPos += (lines.length * 5) + 10;
                    });
                }
            }
            doc.save(`Laporan_${filterName}.pdf`);
        }

        // --- APP UTAMA ---
        const App = () => {
            const [user, setUser] = useState(null);
            const [activeTab, setActiveTab] = useState('input');
            const [students, setStudents] = useState([]);
            const [records, setRecords] = useState([]);
            const [evaluations, setEvaluations] = useState([]);
            const [settings, setSettings] = useState({ tpa: '', teacher: '', logo: '' });
            
            const [raporModalOpen, setRaporModalOpen] = useState(false);
            const [selectedStudentForRapor, setSelectedStudentForRapor] = useState(null);
            const [raporForm, setRaporForm] = useState({ period: '', content: '' });

            const [filterStudent, setFilterStudent] = useState('all');
            const [filterStartDate, setFilterStartDate] = useState(new Date(new Date().setDate(new Date().getDate() - 30)).toISOString().split('T')[0]);
            const [filterEndDate, setFilterEndDate] = useState(new Date().toISOString().split('T')[0]);

            const [form, setForm] = useState({
                date: new Date().toISOString().split('T')[0], studentId: '', readingType: 'iqro', iqroLevel: 'Iqro 1', iqroPage: '', iqroFluency: 'L - Lancar',
                quranSurah: '1. Al-Fatihah', quranAyat: '', quranFluency: 'L - Lancar', hafalans: [{surah:'', ayat:'', fluency:''}],
                doa: '', doaFluency: '', hadits: '', haditsFluency: '', adab: '', adabFluency: '', notes: ''
            });
            const [newStudent, setNewStudent] = useState('');
            const fileInputRef = useRef(null);
            const [editingStudentId, setEditingStudentId] = useState(null);
            const [editNameValue, setEditNameValue] = useState('');

            useEffect(() => {
                window.fb.onAuthStateChanged(window.auth, (u) => {
                    setUser(u);
                    if(u) {
                        setSettings({
                            tpa: localStorage.getItem('tpaName')||'', 
                            teacher: localStorage.getItem('teacherName')||'',
                            logo: localStorage.getItem('appLogo')||''
                        });
                    }
                });
            }, []);

            // OPTIMIZED FETCH: Dependency Array Fixed
            useEffect(() => {
                if(!user) return;
                const { collection, query, onSnapshot, orderBy } = window.fb;
                
                const unsubS = onSnapshot(query(collection(window.db, 'users', user.uid, 'students'), orderBy('name')), snap => 
                    setStudents(snap.docs.map(d=>({id:d.id, ...d.data()})))
                );
                // Limit record fetch jika nanti data banyak, untuk sekarang ambil semua tapi sorted
                const unsubR = onSnapshot(query(collection(window.db, 'users', user.uid, 'records'), orderBy('created_at', 'desc')), snap => 
                    setRecords(snap.docs.map(d=>({id:d.id, ...d.data()})))
                );
                const unsubE = onSnapshot(query(collection(window.db, 'users', user.uid, 'evaluations'), orderBy('created_at', 'desc')), snap => 
                    setEvaluations(snap.docs.map(d=>({id:d.id, ...d.data()})))
                );

                return () => { unsubS(); unsubR(); unsubE(); }
            }, [user?.uid]); // Fix: Hanya jalan ulang jika UID berubah

            const handleLogin = () => window.fb.signInWithPopup(window.auth, new window.fb.GoogleAuthProvider());
            const handleLogout = () => { if(confirm("Keluar?")) window.fb.signOut(window.auth); }
            
            const saveStudent = async () => { if(newStudent) { await window.fb.addDoc(window.fb.collection(window.db, 'users', user.uid, 'students'), {name: newStudent, name_lower: newStudent.toLowerCase()}); setNewStudent(''); alert("Santri Ditambahkan!"); } }
            const deleteStudent = async (id) => { if(confirm("Hapus?")) await window.fb.deleteDoc(window.fb.doc(window.db, 'users', user.uid, 'students', id)); }
            const startEditing = (s) => { setEditingStudentId(s.id); setEditNameValue(s.name); }
            const saveEditedStudent = async () => { if(editNameValue) await window.fb.updateDoc(window.fb.doc(window.db, 'users', user.uid, 'students', editingStudentId), {name: editNameValue}); setEditingStudentId(null); }

            const openRaporModal = (s) => { setSelectedStudentForRapor(s); setRaporModalOpen(true); setRaporForm({period:'', content:''}); }
            const saveRapor = async () => {
                if(!raporForm.period || !raporForm.content) return alert("Lengkapi data!");
                await window.fb.addDoc(window.fb.collection(window.db, 'users', user.uid, 'evaluations'), {
                    studentId: selectedStudentForRapor.id, period: raporForm.period, content: raporForm.content, created_at: window.fb.serverTimestamp()
                });
                setRaporForm({period:'', content:''});
            }
            const deleteRapor = async (id) => { if(confirm("Hapus?")) await window.fb.deleteDoc(window.fb.doc(window.db, 'users', user.uid, 'evaluations', id)); }

            const saveSettings = () => { localStorage.setItem('tpaName', settings.tpa); localStorage.setItem('teacherName', settings.teacher); localStorage.setItem('appLogo', settings.logo); alert("Tersimpan!"); }
            const handleLogoUpload = (e) => { const f = e.target.files[0]; if(f) { const r = new FileReader(); r.onloadend = () => setSettings({...settings, logo: r.result}); r.readAsDataURL(f); } }

            const addHafalanRow = () => setForm({...form, hafalans: [...form.hafalans, {surah:'', ayat:'', fluency:''}]});
            const updateHafalanRow = (idx, f, v) => { const n = [...form.hafalans]; n[idx][f] = v; setForm({...form, hafalans: n}); };
            const removeHafalanRow = (idx) => { const n = form.hafalans.filter((_, i) => i !== idx); setForm({...form, hafalans: n}); };
            
            const saveRecord = async (e) => {
                e.preventDefault();
                if(!form.studentId) return alert("Pilih Santri!");
                const sName = students.find(s=>s.id===form.studentId)?.name;
                await window.fb.addDoc(window.fb.collection(window.db, 'users', user.uid, 'records'), { ...form, hafalans: form.hafalans.filter(h=>h.surah), studentName: sName, created_at: window.fb.serverTimestamp() });
                alert("Tersimpan! ‚úÖ");
                setForm(p => ({...p, notes:'', iqroPage:'', quranAyat:'', hafalans:[{surah:'', ayat:'', fluency:''}], doa:'', hadits:'', adab:''}));
            }
            const deleteRecord = async (id) => { if(confirm("Hapus?")) await window.fb.deleteDoc(window.fb.doc(window.db, 'users', user.uid, 'records', id)); }

            const handleDownloadPDF = () => {
                let sEvals = []; if(filterStudent !== 'all') sEvals = evaluations.filter(e => e.studentId === filterStudent);
                const fRecs = records.filter(r => {
                    const sMatch = filterStudent === 'all' || r.studentId === filterStudent;
                    const dMatch = r.date >= filterStartDate && r.date <= filterEndDate;
                    return sMatch && dMatch;
                });
                const sName = filterStudent === 'all' ? 'all' : students.find(s=>s.id===filterStudent)?.name || 'Santri';
                generatePDF(fRecs, settings, sName, filterStartDate, filterEndDate, sEvals);
            }

            const selDoa = DOA_DATA.find(d => d.title === form.doa);
            const selHadits = HADITS_DATA.find(h => h.title === form.hadits);

            if(!user) return <div className="h-screen flex items-center justify-center bg-slate-50"><button onClick={handleLogin} className="bg-white p-6 rounded-xl shadow-xl text-blue-600 font-bold flex gap-2"><Icon name="login"/> LOGIN GOOGLE</button></div>;

            return (
                <div className="max-w-7xl mx-auto min-h-screen bg-white shadow-2xl flex flex-col md:flex-row overflow-hidden">
                    <aside className="bg-slate-900 text-white w-full md:w-72 p-6 flex flex-col gap-6 flex-shrink-0">
                        <div className="font-bold text-2xl flex items-center gap-3 border-b border-slate-700 pb-4">
                            {settings.logo ? <img src={settings.logo} className="w-10 h-10 rounded object-cover bg-white"/> : <div className="bg-blue-600 p-2 rounded"><Icon name="book" className="text-white"/></div>} 
                            Catatan Ngaji
                        </div>
                        <nav className="flex-1 space-y-3">
                            <button onClick={()=>setActiveTab('input')} className={`w-full text-left px-4 py-3 rounded-xl flex gap-3 ${activeTab==='input'?'bg-blue-600 shadow-lg':'hover:bg-slate-800'}`}><Icon name="plus"/> Input Harian</button>
                            <button onClick={()=>setActiveTab('students')} className={`w-full text-left px-4 py-3 rounded-xl flex gap-3 ${activeTab==='students'?'bg-blue-600 shadow-lg':'hover:bg-slate-800'}`}><Icon name="users"/> Data Santri</button>
                            <button onClick={()=>setActiveTab('recap')} className={`w-full text-left px-4 py-3 rounded-xl flex gap-3 ${activeTab==='recap'?'bg-blue-600 shadow-lg':'hover:bg-slate-800'}`}><Icon name="chart"/> Laporan PDF</button>
                        </nav>
                        <div className="mt-auto pt-6 border-t border-slate-700 flex items-center gap-3"><img src={user.photoURL} className="w-10 h-10 rounded-full"/><div className="text-sm font-bold truncate w-32">{user.displayName}</div><button onClick={handleLogout} className="text-red-400"><Icon name="logout"/></button></div>
                    </aside>

                    <main className="flex-1 flex flex-col h-screen overflow-hidden bg-slate-50 relative">
                        <header className="bg-white border-b p-6 flex justify-between items-center shadow-sm z-10">
                            <div><h2 className="text-2xl font-bold text-slate-800">Assalamu'alaikum, <span className="text-blue-600">Ustadz/Ustadzah {settings.teacher}</span></h2></div>
                            <div className="hidden md:block text-right"><p className="text-xs font-bold text-slate-400">HARI INI</p><p className="font-bold text-slate-800">{new Date().toLocaleDateString('id-ID', {dateStyle:'full'})}</p></div>
                        </header>

                        <div className="flex-1 overflow-y-auto p-4 md:p-8">
                            {/* TAB INPUT */}
                            {activeTab === 'input' && (
                                <div className="space-y-6 animate-fade max-w-4xl mx-auto">
                                    <div className="bg-white p-5 rounded-xl shadow-sm border flex gap-4 items-center">
                                        <div onClick={()=>fileInputRef.current.click()} className="w-12 h-12 rounded border-2 border-dashed flex items-center justify-center cursor-pointer">{settings.logo?<img src={settings.logo} className="w-full h-full object-cover"/>:<Icon name="upload"/>}</div>
                                        <input type="file" ref={fileInputRef} onChange={handleLogoUpload} className="hidden" accept="image/*"/>
                                        <div className="flex-1 gap-2 flex flex-col"><input placeholder="Nama TPA" value={settings.tpa} onChange={e=>setSettings({...settings, tpa:e.target.value})} className="border-b font-bold w-full outline-none"/><input placeholder="Nama Guru" value={settings.teacher} onChange={e=>setSettings({...settings, teacher:e.target.value})} className="border-b font-bold w-full outline-none"/></div>
                                        <button onClick={saveSettings} className="bg-slate-100 px-4 py-2 rounded font-bold text-xs"><Icon name="save"/> SIMPAN</button>
                                    </div>

                                    <form onSubmit={saveRecord} className="space-y-6">
                                        <div className="bg-white p-6 rounded-xl shadow-sm border grid grid-cols-1 md:grid-cols-2 gap-6">
                                            <div><label className="text-xs font-bold text-slate-400">TANGGAL</label><input type="date" value={form.date} onChange={e=>setForm({...form, date:e.target.value})} className="w-full border p-2 rounded-lg"/></div>
                                            <div>
                                                <label className="text-xs font-bold text-slate-400">PILIH SANTRI</label>
                                                <select value={form.studentId} onChange={e=>setForm({...form, studentId:e.target.value})} className="w-full border p-2 rounded-lg font-bold">
                                                    <option value="">-- Pilih Nama --</option>
                                                    {students.map(s=><option key={s.id} value={s.id}>{s.name}</option>)}
                                                </select>
                                                {students.length === 0 && <p className="text-xs text-red-500 mt-1">*Input Santri dulu di menu Data Santri</p>}
                                            </div>
                                        </div>

                                        <div className="bg-emerald-50 p-6 rounded-xl border border-emerald-100 shadow-sm">
                                            <h3 className="font-bold text-emerald-800 mb-4 flex gap-2"><Icon name="book"/> BACAAN UTAMA</h3>
                                            <div className="flex gap-4 mb-4"><label className="flex gap-2 font-bold"><input type="radio" checked={form.readingType==='iqro'} onChange={()=>setForm({...form, readingType:'iqro'})}/> IQRO</label><label className="flex gap-2 font-bold"><input type="radio" checked={form.readingType==='quran'} onChange={()=>setForm({...form, readingType:'quran'})}/> AL-QURAN</label></div>
                                            <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                                {form.readingType === 'iqro' ? (<><select value={form.iqroLevel} onChange={e=>setForm({...form, iqroLevel:e.target.value})} className="border p-2 rounded-lg">{IQRO_LEVELS.map(l=><option key={l}>{l}</option>)}</select><input placeholder="Hal" value={form.iqroPage} onChange={e=>setForm({...form, iqroPage:e.target.value})} className="border p-2 rounded-lg"/><select value={form.iqroFluency} onChange={e=>setForm({...form, iqroFluency:e.target.value})} className="border p-2 rounded-lg"><option>L - Lancar</option><option>BL - Belum</option><option>U - Ulangi</option></select></>) : (<><select value={form.quranSurah} onChange={e=>setForm({...form, quranSurah:e.target.value})} className="border p-2 rounded-lg">{SURAH_LIST.map(s=><option key={s}>{s}</option>)}</select><input placeholder="Ayat" value={form.quranAyat} onChange={e=>setForm({...form, quranAyat:e.target.value})} className="border p-2 rounded-lg"/><select value={form.quranFluency} onChange={e=>setForm({...form, quranFluency:e.target.value})} className="border p-2 rounded-lg"><option>L - Lancar</option><option>BL - Belum</option><option>U - Ulangi</option></select></>)}
                                            </div>
                                        </div>

                                        <div className="bg-purple-50 p-6 rounded-xl border border-purple-100 shadow-sm">
                                            <h3 className="font-bold text-purple-800 mb-4 flex justify-between"><span><Icon name="star"/> SETORAN HAFALAN</span><button type="button" onClick={addHafalanRow} className="text-xs bg-purple-200 px-2 py-1 rounded">+ Baris</button></h3>
                                            {form.hafalans.map((h, idx) => (
                                                <div key={idx} className="flex gap-2 mb-2 items-center"><select value={h.surah} onChange={e=>updateHafalanRow(idx, 'surah', e.target.value)} className="flex-1 border p-2 rounded-lg text-sm"><option value="">- Surah -</option>{SURAH_LIST.map(s=><option key={s}>{s}</option>)}</select><input placeholder="Ayat" value={h.ayat} onChange={e=>updateHafalanRow(idx, 'ayat', e.target.value)} className="w-20 border p-2 rounded-lg text-sm"/><select value={h.fluency} onChange={e=>updateHafalanRow(idx, 'fluency', e.target.value)} className="w-24 border p-2 rounded-lg text-sm"><option value="">- Nilai -</option><option>L - Lancar</option><option>BL - Belum</option></select>{form.hafalans.length>1 && <button type="button" onClick={()=>removeHafalanRow(idx)} className="text-red-400"><Icon name="minus"/></button>}</div>
                                            ))}
                                        </div>

                                        <div className="bg-amber-50 p-6 rounded-xl border border-amber-100 shadow-sm">
                                            <h3 className="font-bold text-amber-800 mb-4 flex gap-2"><Icon name="sun"/> MATERI TAMBAHAN</h3>
                                            <div className="flex flex-col gap-6">
                                                <div className="border-b border-amber-200 pb-4">
                                                    <label className="font-bold text-amber-900 block mb-2">1. DOA HARIAN</label>
                                                    <div className="flex flex-col gap-2 mb-2">
                                                        <select value={form.doa} onChange={e=>setForm({...form, doa:e.target.value})} className="w-full border p-2 rounded-lg text-sm"><option value="">- Pilih Doa -</option>{DOA_DATA.map(d=><option key={d.title} value={d.title}>{d.title}</option>)}</select>
                                                        <select value={form.doaFluency} onChange={e=>setForm({...form, doaFluency:e.target.value})} className="w-full border p-2 rounded-lg text-sm bg-white"><option value="">- Beri Nilai -</option><option>L - Lancar</option><option>BL - Belum</option></select>
                                                    </div>
                                                    {selDoa && <div className="bg-white p-4 rounded-xl border text-center shadow-sm"><p className="font-arabic text-3xl mb-2 leading-relaxed">{selDoa.arabic}</p><p className="text-sm italic text-slate-500">{selDoa.meaning}</p></div>}
                                                </div>
                                                <div className="border-b border-amber-200 pb-4">
                                                    <label className="font-bold text-amber-900 block mb-2">2. HADITS PILIHAN</label>
                                                    <div className="flex flex-col gap-2 mb-2">
                                                        <select value={form.hadits} onChange={e=>setForm({...form, hadits:e.target.value})} className="w-full border p-2 rounded-lg text-sm"><option value="">- Pilih Hadits -</option>{HADITS_DATA.map(h=><option key={h.title} value={h.title}>{h.title}</option>)}</select>
                                                        <select value={form.haditsFluency} onChange={e=>setForm({...form, haditsFluency:e.target.value})} className="w-full border p-2 rounded-lg text-sm bg-white"><option value="">- Beri Nilai -</option><option>L - Lancar</option><option>BL - Belum</option></select>
                                                    </div>
                                                    {selHadits && <div className="bg-white p-4 rounded-xl border text-center shadow-sm"><p className="font-arabic text-3xl mb-2 leading-relaxed">{selHadits.arabic}</p><p className="text-sm italic text-slate-500">{selHadits.meaning}</p></div>}
                                                </div>
                                                <div>
                                                    <label className="font-bold text-amber-900 block mb-2">3. ADAB ISLAM</label>
                                                    <div className="flex flex-col gap-2">
                                                        <select value={form.adab} onChange={e=>setForm({...form, adab:e.target.value})} className="w-full border p-2 rounded-lg text-sm"><option value="">- Pilih Adab -</option>{ADAB_LIST.map(a=><option key={a} value={a}>{a}</option>)}</select>
                                                        <select value={form.adabFluency} onChange={e=>setForm({...form, adabFluency:e.target.value})} className="w-full border p-2 rounded-lg text-sm bg-white"><option value="">- Beri Nilai -</option><option>L - Lancar</option><option>BL - Belum</option></select>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <textarea placeholder="Catatan tambahan..." value={form.notes} onChange={e=>setForm({...form, notes:e.target.value})} className="w-full border p-3 rounded-xl h-24"/>
                                        <button type="submit" className="w-full bg-blue-600 text-white py-4 rounded-xl font-bold shadow-lg"><Icon name="save"/> SIMPAN DATA</button>
                                    </form>
                                    
                                    {records.filter(r=>r.date===form.date).length > 0 && <div className="mt-8 bg-white p-4 rounded-xl shadow-sm"><h3 className="font-bold mb-2">Riwayat Hari Ini</h3>{records.filter(r=>r.date===form.date).map(r=><div key={r.id} className="flex justify-between border-b py-2"><span>{r.studentName} - {r.readingType}</span><button onClick={()=>deleteRecord(r.id)} className="text-red-500"><Icon name="trash"/></button></div>)}</div>}
                                </div>
                            )}

                            {/* TAB DATA SANTRI */}
                            {activeTab === 'students' && (
                                <div className="bg-white p-6 rounded-xl shadow-sm border animate-fade">
                                    <div className="bg-blue-50 p-4 rounded-lg border border-blue-100 mb-6 flex gap-2">
                                        <input placeholder="Nama Santri Baru..." value={newStudent} onChange={e=>setNewStudent(e.target.value)} className="flex-1 border p-2 rounded-lg"/>
                                        <button onClick={saveStudent} className="bg-blue-600 text-white px-4 py-2 rounded-lg font-bold">TAMBAH</button>
                                    </div>
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        {students.map(s=>(
                                            <div key={s.id} className="flex flex-col p-4 bg-slate-50 rounded-xl border relative">
                                                {editingStudentId === s.id ? (
                                                    <div className="flex gap-2"><input value={editNameValue} onChange={e=>setEditNameValue(e.target.value)} className="border p-2 rounded w-full"/><button onClick={saveEditedStudent} className="bg-green-500 text-white px-2 rounded">OK</button></div>
                                                ) : (
                                                    <div className="flex justify-between items-center mb-4">
                                                        <div className="flex items-center gap-3"><div className="w-10 h-10 rounded-full bg-blue-500 text-white flex items-center justify-center font-bold">{s.name[0]}</div><div className="font-bold text-lg">{s.name}</div></div>
                                                        <div className="flex gap-1"><button onClick={()=>startEditing(s)} className="text-blue-400 bg-white p-2 rounded border"><Icon name="edit"/></button><button onClick={()=>deleteStudent(s.id)} className="text-red-400 bg-white p-2 rounded border"><Icon name="trash"/></button></div>
                                                    </div>
                                                )}
                                                <button onClick={()=>openRaporModal(s)} className="w-full bg-orange-100 text-orange-700 py-2 rounded-lg font-bold text-sm border border-orange-200 hover:bg-orange-200 flex justify-center gap-2"><Icon name="file"/> RAPOR & CATATAN</button>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            )}

                            {/* TAB REKAP */}
                            {activeTab === 'recap' && (
                                <div className="bg-white p-6 rounded-xl shadow-sm border animate-fade">
                                    <div className="flex flex-col md:flex-row justify-between mb-6 gap-4">
                                        <h2 className="font-bold text-xl"><Icon name="calendar"/> Rekapitulasi</h2>
                                        <div className="flex gap-2 items-center">
                                            <input type="date" value={filterStartDate} onChange={e=>setFilterStartDate(e.target.value)} className="border rounded px-2 py-1"/>
                                            <span>-</span>
                                            <input type="date" value={filterEndDate} onChange={e=>setFilterEndDate(e.target.value)} className="border rounded px-2 py-1"/>
                                        </div>
                                    </div>
                                    <div className="flex gap-2 mb-4">
                                        <select value={filterStudent} onChange={e=>setFilterStudent(e.target.value)} className="flex-1 bg-blue-50 border-blue-200 py-2 px-4 rounded-xl font-bold"><option value="all">Semua Santri</option>{students.map(s=><option key={s.id} value={s.id}>{s.name}</option>)}</select>
                                        <button onClick={handleDownloadPDF} className="bg-red-600 text-white px-6 py-2 rounded-xl font-bold flex items-center gap-2"><Icon name="download"/> PDF</button>
                                    </div>
                                    <div className="overflow-x-auto rounded-lg border">
                                        <table className="w-full text-sm text-left"><thead className="bg-slate-800 text-white"><tr><th className="p-3">Tanggal</th><th className="p-3">Nama</th><th className="p-3">Materi</th><th className="p-3">Tambahan</th></tr></thead>
                                            <tbody className="divide-y">
                                                {records.filter(r => (filterStudent==='all' || r.studentId===filterStudent) && r.date >= filterStartDate && r.date <= filterEndDate).map(r=>(
                                                    <tr key={r.id} className="hover:bg-slate-50">
                                                        <td className="p-3 align-top">{r.date}</td>
                                                        <td className="p-3 align-top font-bold">{r.studentName}</td>
                                                        <td className="p-3 align-top">
                                                            <div className="font-semibold text-blue-700">{r.readingType==='iqro'?r.iqroLevel:r.quranSurah}</div>
                                                            <div className="text-xs text-slate-500">{r.readingType==='iqro'?`Hal ${r.iqroPage}`:`Ayat ${r.quranAyat}`} <span className="font-bold">({r.readingType==='iqro'?r.iqroFluency.split(' - ')[0]:r.quranFluency.split(' - ')[0]})</span></div>
                                                            {(r.hafalans || []).map((h, i) => <div key={i} className="text-xs text-purple-600 mt-1 font-bold">‚≠ê {h.surah} : {h.ayat} ({h.fluency.split(' - ')[0]})</div>)}
                                                            {!r.hafalans && r.hafalanSurah && <div className="text-xs text-purple-600 mt-1 font-bold">‚≠ê {r.hafalanSurah} : {r.hafalanAyat} ({r.hafalanFluency.split(' - ')[0]})</div>}
                                                        </td>
                                                        <td className="p-3 align-top text-xs italic space-y-1">
                                                            {r.doa && r.doaFluency && <div className="text-amber-700">{r.doa} ({r.doaFluency.split(' - ')[0]})</div>}
                                                            {r.hadits && r.haditsFluency && <div className="text-amber-700">{r.hadits} ({r.haditsFluency.split(' - ')[0]})</div>}
                                                            {r.adab && r.adabFluency && <div className="text-amber-700">{r.adab} ({r.adabFluency.split(' - ')[0]})</div>}
                                                        </td>
                                                    </tr>
                                                ))}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            )}
                        </div>

                        {/* MODAL RAPOR */}
                        {raporModalOpen && selectedStudentForRapor && (
                            <div className="fixed inset-0 modal-overlay flex items-center justify-center p-4 z-50">
                                <div className="bg-white rounded-2xl shadow-2xl w-full max-w-lg overflow-hidden flex flex-col max-h-[90vh]">
                                    <div className="p-4 border-b bg-orange-50 flex justify-between items-center">
                                        <h3 className="font-bold text-orange-900 flex items-center gap-2"><Icon name="file"/> Rapor: {selectedStudentForRapor.name}</h3>
                                        <button onClick={()=>setRaporModalOpen(false)} className="text-gray-500 hover:text-gray-800 font-bold">‚úï</button>
                                    </div>
                                    <div className="p-4 flex-1 overflow-y-auto bg-slate-50">
                                        <div className="space-y-4 mb-6">
                                            {evaluations.filter(e => e.studentId === selectedStudentForRapor.id).length === 0 && <p className="text-center text-gray-400 italic py-4">Belum ada catatan rapor.</p>}
                                            {evaluations.filter(e => e.studentId === selectedStudentForRapor.id).map(e => (
                                                <div key={e.id} className="bg-white p-4 rounded-xl border shadow-sm relative group">
                                                    <div className="font-bold text-orange-700 text-sm mb-1">{e.period}</div>
                                                    <p className="text-sm text-gray-700 whitespace-pre-wrap">{e.content}</p>
                                                    <button onClick={()=>deleteRapor(e.id)} className="absolute top-2 right-2 text-red-300 hover:text-red-500"><Icon name="trash" size={14}/></button>
                                                </div>
                                            ))}
                                        </div>
                                        <div className="bg-white p-4 rounded-xl border">
                                            <h4 className="font-bold text-sm mb-2 text-gray-500 uppercase">Tambah Catatan Baru</h4>
                                            <input placeholder="Judul Periode (Cth: Januari 2026)" className="w-full border p-2 rounded mb-2 text-sm font-bold" value={raporForm.period} onChange={ev=>setRaporForm({...raporForm, period:ev.target.value})}/>
                                            <textarea placeholder="Tulis evaluasi, perkembangan, dan kesimpulan..." className="w-full border p-2 rounded mb-2 text-sm h-24" value={raporForm.content} onChange={ev=>setRaporForm({...raporForm, content:ev.target.value})}/>
                                            <button onClick={saveRapor} className="w-full bg-orange-600 text-white py-2 rounded font-bold hover:bg-orange-700">SIMPAN CATATAN</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}

                    </main>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
.
</html>
